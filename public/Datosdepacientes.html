<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="icon" href="/assets/logo.png" sizes="200x200 100x100" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css" />

    <style>
        body {
            display: flex;
        }

        .sidebar {
            width: 250px;
            height: 100vh;
            background: #343a40;
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            padding-top: 20px;
            text-align: center;
        }

        .sidebar img {
            width: 50px;
            margin-bottom: 10px;
        }

        .sidebar h4 {
            margin-bottom: 20px;
            font-size: 20px;
        }

        .sidebar a {
            padding: 15px 10px;
            text-decoration: none;
            font-size: 18px;
            color: white;
            display: block;
        }

        .sidebar a:hover {
            background: #495057;
        }

        .sidebar .logout-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            cursor: pointer;
            width: 100%;
            padding: 10px;
            margin-top: 20px;
        }

        .content {
            margin-left: 250px;
            padding: 20px;
            width: 100%;
        }

        .top-bar {
            display: flex;
            justify-content: flex-end;
            padding: 10px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }

        .form-container {
            max-width: 600px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

         /* Botón cerrar sesión arriba */
         .top-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 10px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }

        .top-bar button {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 16px;
            cursor: pointer;
        }

        .top-bar button:hover {
            color: #c82333;
        }

        .table-container {
            border: 1px solid #ddd;
            border-radius: 0.45rem;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            background-color: white;
        }
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: #9aa3f9;
        }
        .table-header .table-title {
            font-family: Arial, sans-serif;
            font-size: 24px;
            font-weight: bold;
        }
        .table-header .search-container {
            display: flex;
            align-items: center;
        }
        .table-header .search-container input {
            border-radius: 0.25rem;
            border: 1px solid #ddd;
            padding: 0.5rem;
            margin-right: 0.5rem;
        }
        .table-custom {
            width: 100%;
        }
        .table-custom th, .table-custom td {
            text-align: center;
            vertical-align: middle;
            padding: 0.75rem;
        }
        .table-custom th {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        .table-custom .table-footer {
            background-color: #f8f9fa;
            text-align: right;
            padding: 0.75rem;
        }


        .sidebar a.logo img {
    cursor: pointer;
    transition: none !important; /* Evita efectos de transición */
}

.sidebar a.logo:focus img, a.logo:active img {
    outline: none !important;
    box-shadow: none !important;
    filter: none !important;
}

.sidebar a.logo:hover,
.sidebar a.logo:hover img,
.sidebar a.logo:hover h4 {
    filter: none !important;
    color: inherit !important;
    background: transparent !important;
    box-shadow: none !important;
    text-decoration: none !important;
    opacity: 1 !important;
    transition: none !important;
}

/* Menú desplegable personalizado dentro de la sidebar */
.dropdown-container {
    position: relative;
    text-align: left;
    margin-bottom: 10px;
}

.main-title {
    background-color: #343a40;
    color: white;
    padding: 12px 16px;
    font-size: 18px;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.main-title:hover {
    background-color: #495057;
}

.dropdown-menu {
    display: none;
    position: absolute;
    left: 100%; /* Aparece al lado derecho de la sidebar */
    top: 0;
    background-color: #f8f9fa;
    border-radius: 6px;
    box-shadow: 0 0 8px rgba(0,0,0,0.15);
    min-width: 200px;
    z-index: 1000;
    flex-direction: column;
}

.dropdown-menu a {
    display: block;
    padding: 10px 16px;
    color: #343a40;
    text-decoration: none;
    font-size: 16px;
}

.dropdown-menu a:hover {
    background-color: #343a40;
    color: #f8f9fa;
}

/* Mostrar el menú cuando el mouse pasa por el contenedor */
.main-title:hover + .dropdown-menu {
    display: block;
}


    </style>
</head>
<body>
    <div class="sidebar">
        <a href="/inicio.html" class="logo"><img src="/assets/logo.png" alt="CardioCloud Logo"><h4></h4></a>       
        <a href="/inicio.html">Perfiles de mis pacientes</a>
        <a href="/formulario">Registro de pacientes</a>
        <a href="/Perfiles-pacientes">Perfiles de pacientes</a>
        <a href="/Datosdepacientes">Banco de pacientes</a>
 
        <button class="logout-btn" onclick="window.location.href='/logout'">
            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
        </button>
    </div>

    <div class="content">
        <div class="top-bar">
            <button onclick="window.location.href='/logout'">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
            </button>
        </div>
        <script>
document.addEventListener('DOMContentLoaded', () => {
    const title = document.querySelector('.main-title');
    const menu = document.querySelector('.dropdown-menu');

    let overMenu = false;

    title.addEventListener('mouseenter', () => {
        menu.style.display = 'block';
    });

    title.addEventListener('mouseleave', () => {
        setTimeout(() => {
            if (!overMenu) menu.style.display = 'none';
        }, 200);
    });

    menu.addEventListener('mouseenter', () => {
        overMenu = true;
    });

    menu.addEventListener('mouseleave', () => {
        overMenu = false;
        menu.style.display = 'none';
    });
});
</script>
 

    <div class="container mt-5">
        <div class="table-container">
            <div class="table-header">
                <div class="table-title">Banco de pacientes</div>
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Buscar">
                    <button class="btn btn-outline-light" onclick="buscar()">Buscar</button>
                    <div class="suggestions" id="suggestions"></div>
                </div>

            </div>
            
        <table class="table table-custom">
            </thead>
                <tr>
                    <th scope="col">Nombre</th>
                    <th scope="col">Fecha Nacimiento</th>
                    <th scope="col">Género</th>
                    <th scope="col">Teléfono</th>
                    <th scope="col">Email</th>
                    <th scope="col">Fecha Registro</th>
                    <th scope="col">Archivos</th>
                    <th id="accionesHeader1">Doctores que lo consultaron</th>
                    <th id="accionesHeader2">Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaPacientes">
            </tbody>
        </table>

        <!-- Contenedor para mensajes de éxito o error -->
        <div id="messageContainer" class="mt-3"></div>
    </div>

<!-- Modal para subir archivos -->
<div class="modal fade" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadModalLabel">Subir Archivos para <span id="patientName"></span></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="uploadForm">
                    <div class="form-group">
                        <label for="fileType">Tipo de Archivo</label>
                        <select class="form-control" id="fileType">
                            <option value="electrocardiograma">Electrocardiograma</option>
                            <option value="fonocardiograma">Fonocardiograma</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fileInput">Seleccionar archivo</label>
                        <input type="file" class="form-control-file" id="fileInput">
                    </div>
                    <input type="hidden" id="patientId" value="">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger" data-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-outline-info" onclick="submitFile()">Subir Archivo</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal de confirmación -->
<div class="modal fade" id="modalConfirmarEliminacion" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalLabel">Confirmar eliminación</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        ¿Estás seguro de querer eliminar al paciente <strong id="nombrePacienteModal"></strong>?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="btnConfirmarEliminar">Eliminar</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal de éxito -->
<div class="modal fade" id="modalExitoEliminacion" tabindex="-1" role="dialog" aria-labelledby="modalExitoLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content border-success">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="modalExitoLabel">Eliminación exitosa</h5>
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Cerrar">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" id="mensajeExito">
        <!-- Aquí va el mensaje dinámico -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" data-dismiss="modal">Aceptar</button>
      </div>
    </div>
  </div>
</div>


<!-- Modal de éxito para subida de archivos -->
<div class="modal fade" id="uploadSuccessModal" tabindex="-1" role="dialog" aria-labelledby="uploadSuccessModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadSuccessModalLabel">Subida Exitosa</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Archivo subido con éxito.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-success" data-dismiss="modal">Aceptar</button>
            </div>
        </div>
    </div>
</div>
 <!-- Modal de error -->
 <div id="errorModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">Error</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="errorModalMessage"></p> <!-- Aquí se muestra el mensaje de error -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>


    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <script>
   let pacientesData = []; // Almacenar todos los pacientes cargados
let esAdmin = false; // ✅ Aquí se define la variable global
let pacienteAEliminar = null;
// Al cargar la página, primero obtenemos el rol del usuario
document.addEventListener("DOMContentLoaded", function () {
    fetch("/api/rol")
        .then(res => res.json())
        .then(data => {
            esAdmin = data.codigo === "Admincode"; // ✅ Aquí se determina si es admin
            actualizarSidebar();
            cargarPacientes(); // ✅ Solo se llama después de conocer el rol
        })
        .catch(error => {
            console.error("Error obteniendo el rol del usuario:", error);
        });
});

    function cargarPacientes() {
        fetch('/consultarpx')
            .then(response => response.json())
            .then(data => {
                pacientesData = data.pacientes;  // Guardar los datos en la variable global
                mostrarPacientes(data.pacientes);
            })
            .catch(error => console.error('Error al cargar los pacientes:', error));
    }

   function mostrarPacientes(data) {
    const tabla = document.getElementById('tablaPacientes');
    tabla.innerHTML = ''; // Limpiar filas existentes

    // Ocultar o mostrar la columna de acciones en el encabezado
    const accionesHeader1 = document.getElementById('accionesHeader1');
    if (accionesHeader1) {
        accionesHeader1.style.display = esAdmin ? 'table-cell' : 'none';
    }

     const accionesHeader2 = document.getElementById('accionesHeader2');
    if (accionesHeader2) {
        accionesHeader2.style.display = esAdmin ? 'table-cell' : 'none';
    }

    data.forEach(paciente => {
        const fila = tabla.insertRow();

        // Nombre con enlace
        fila.insertCell().innerHTML = `<a href="/paciente.html?id=${paciente.id}">${paciente.nombre}</a>`;

        // Fecha de nacimiento
        const fechaNacimiento = new Date(paciente.fecha_nacimiento);
        fechaNacimiento.setMinutes(fechaNacimiento.getMinutes() + fechaNacimiento.getTimezoneOffset());
        fila.insertCell().textContent = fechaNacimiento.toLocaleDateString('es-MX');

        // Otros campos
        fila.insertCell().textContent = paciente.genero;
        fila.insertCell().textContent = paciente.telefono;
        fila.insertCell().textContent = paciente.email;

        const fechaRegistro = new Date(paciente.fecha_registro).toLocaleDateString('es-MX');
        fila.insertCell().textContent = fechaRegistro;

        // Botón para subir archivos
        fila.insertCell().innerHTML = `<a href="#" class="btn btn-outline-info btn-sm" data-toggle="modal" data-target="#uploadModal" data-id="${paciente.id}">Subir</a>`;

        // Doctores que lo consultaron
        

        // Columna "Acciones": solo si es admin
      

if (esAdmin) {
    fila.insertCell().textContent = paciente.doctores || 'Sin consultas';
    const cellAcciones = fila.insertCell();
    const btnEliminar = document.createElement('button');
    btnEliminar.className = 'btn btn-outline-danger btn-sm';
    btnEliminar.textContent = 'Eliminar';
    btnEliminar.onclick = function () {
        pacienteAEliminar = paciente; // Guarda el paciente actual
        document.getElementById('nombrePacienteModal').textContent = paciente.nombre;
        $('#modalConfirmarEliminacion').modal('show'); // Muestra el modal
    };
    cellAcciones.appendChild(btnEliminar);
} else {
    // Insertar celda vacía si no es admin, para mantener estructura
    fila.insertCell().style.display = 'none';
}

    });
}

function actualizarSidebar() {
    const sidebar = document.querySelector('.sidebar');
    if (!sidebar) return;

    if (esAdmin) {
        sidebar.innerHTML = `
            <a href="/Admin.html" class="logo">
                <img src="/assets/logo.png" alt="CardioCloud Logo">
                <h4></h4>
            </a>

            <div class="dropdown-container" id="banco-container">
                <div class="main-title" id="banco-toggle">Bancos de pacientes</div>
                <div class="dropdown-menu" id="banco-menu">
                    <a href="/Perfiles-pacientes.html">Tabla de usuarios (px)</a>
                    <a href="/Datosdepacientes.html">Tabla de pacientes</a>
                </div>
            </div>

            <a href="/Registrodepaciente">Registro de pacientes</a>
            <a href="/Admin.html">Inicio</a>

            <button class="logout-btn" onclick="window.location.href='/logout'">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
            </button>
        `;

        const container = document.getElementById("banco-container");
        const menu = document.getElementById("banco-menu");

        // Mostrar menú al pasar el cursor por el contenedor
        container.addEventListener("mouseenter", () => {
            menu.style.display = "block";
        });

        // Ocultar menú cuando se quite el cursor del contenedor completo
        container.addEventListener("mouseleave", () => {
            menu.style.display = "none";
        });

        // Asegurarte de que la sidebar no desaparezca nunca
        sidebar.style.display = "block";
    }
}

        
        // Función para configurar la ID del paciente en el formulario modal
    $('#uploadModal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget);
        var patientId = button.data('id');
        var patientName = button.closest('tr').find('td:first-child').text(); // Obtener el nombre del paciente
        var modal = $(this);
        modal.find('.modal-title').text('Subir Archivos para ' + patientName);
        modal.find('#patientId').val(patientId);
        modal.find('#patientName').text(patientName); // Establecer el nombre del paciente en el modal
    });


        function submitFile() {
            var fileInput = $('#fileInput')[0].files[0];
    var fileType = $('#fileType').val();
    var patientId = $('#patientId').val();
           // Verificar que un archivo haya sido seleccionado
    if (!fileInput) {
        $('#errorModal').modal('show');
        $('#errorModalMessage').text('No se ha seleccionado un archivo.');
        return;
    }

    // Verificar la extensión del archivo
        var allowedExtensions = ['mp3', 'wav', 'dat', 'hea']; // No incluir el punto
        var fileExtension = fileInput.name.split('.').pop().toLowerCase(); // Obtener la extensión en minúsculas

    if (!allowedExtensions.includes(fileExtension)) {
        // Mostrar un modal de error si el archivo no es válido
        $('#errorModal').modal('show');
        $('#errorModalMessage').text('Archivo no válido. Solo se permiten archivos .mp3, .wav, .dat y .hea.');
        return;  // Detener la ejecución si el archivo no es válido
    }

            var formData = new FormData();
            formData.append('file', $('#fileInput')[0].files[0]);
            formData.append('type', $('#fileType').val());  // Incluir el tipo de archivo seleccionado
            formData.append('patientId', $('#patientId').val());  // ID del paciente para asociar el archivo

            console.log("Datos a enviar:");
            console.log("File:", $('#fileInput')[0].files[0]);
            console.log("Type:", $('#fileType').val());
            console.log("Patient ID:", $('#patientId').val());

                    $.ajax({
                        type: "POST",
                        url: "/subirarchivo",
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            if(response.success){
                                $('#uploadModal').modal('hide');
                                $('#uploadSuccessModal').modal('show');
                                setTimeout(() => {
                                    $('#uploadSuccessModal').modal('hide');
                                }, 3000);
                            cargarPacientes(); // Recargar la lista de pacientes para reflejar los cambios
                            }else{
                                 $('#uploadModal').modal('hide');
                                 $('#uploadFailModal').modal('show');
                            }
                        },
                        error: function () {
                            $('#uploadModal').modal('hide');
                            $('#uploadFailModal').modal('show');
                        }
                    });
                }

                function buscar() {
                    const input = document.getElementById('searchInput').value.toLowerCase();
                   const suggestions = document.getElementById('suggestions');
                    suggestions.innerHTML = ''; // Clear existing suggestions
                    if (input === '') {
                        mostrarPacientes(pacientesData);
                        return;
                    }

                    const filteredData = pacientesData.filter(paciente => paciente.nombre.toLowerCase().includes(input));
                    mostrarPacientes(filteredData);

                    filteredData.forEach(paciente => {
                        const suggestionItem = document.createElement('div');
                        suggestionItem.classList.add('suggestion-item');
                        suggestionItem.textContent = paciente.nombre;
                        suggestionItem.onclick = () => {
                            document.getElementById('searchInput').value = paciente.nombre;
                            suggestions.innerHTML = '';
                            mostrarPacientes([paciente]);
                        };
                        suggestions.appendChild(suggestionItem);
                    });
                }
document.getElementById('btnConfirmarEliminar').addEventListener('click', function () {
    if (pacienteAEliminar) {
        eliminarPaciente(pacienteAEliminar.id);
        $('#modalConfirmarEliminacion').modal('hide');
    }
});
function eliminarPaciente(id) {
    fetch(`/eliminarpaciente/${id}`, {
        method: 'DELETE'
    })
    .then(async response => {
        if (!response.ok) {
            const text = await response.text();
            throw new Error(text);
        }
        return response.json();
    })
    .then(data => {
        // Mostrar mensaje en el modal
        document.getElementById('mensajeExito').textContent = data.message;
        $('#modalExitoEliminacion').modal('show');
        setTimeout(()=>{
        location.reload();
        },1500);
    })
    .catch(error => {
        console.error('Error al eliminar:', error);
        alert('Error al eliminar: ' + error.message);
    });
}





    </script>
</body>

</html>