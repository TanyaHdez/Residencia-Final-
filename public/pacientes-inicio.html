<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi historial clínico</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="icon" href="/assets/logo.png" sizes="16x16 32x32" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css" />
  <style>
        body {
            display: flex;
        }

        .sidebar {
            width: 250px;
            height: 100vh;
            background: #343a40;
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            padding-top: 20px;
            text-align: center;
        }

        .sidebar img {
            width: 50px;
            margin-bottom: 10px;
        }

        .sidebar h4 {
            margin-bottom: 20px;
            font-size: 20px;
        }

        .sidebar a {
            padding: 15px 10px;
            text-decoration: none;
            font-size: 18px;
            color: white;
            display: block;
        }

        .sidebar a:hover {
            background: #495057;
        }

        .sidebar .logout-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            cursor: pointer;
            width: 100%;
            padding: 10px;
            margin-top: 20px;
        }

        .content {
            margin-left: 250px;
            padding: 20px;
            width: 100%;
        }

        .top-bar {
            display: flex;
            justify-content: flex-end;
            padding: 10px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }

        .form-container {
            max-width: 600px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

         /* Botón cerrar sesión arriba */
         .top-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 10px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }

        .top-bar button {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 16px;
            cursor: pointer;
        }

        .top-bar button:hover {
            color: #c82333;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <img src="/assets/logo.png" alt="CardioCloud Logo">
        <h4></h4>
        <button class="logout-btn" onclick="window.location.href='/logout'">
            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
        </button>
    </div>

    <div class="content">
        <div class="top-bar">
            <button onclick="window.location.href='/logout'">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
            </button>
        </div>

        <div class="container mt-5">
            <h2>Mi registro</h2>
            <h5>Rellenar el formulario completo</h5>
            <form id="registro-paciente-form">
                <div class="form-group">
                    <label for="nombres">Nombre Completo</label>
                    <div class="form-row">
                        <div class="col">
                            <input type="text" class="form-control" id="nombres" name="nombres" placeholder="Nombres"
                                required>
                        </div>
                        <div class="col">
                            <input type="text" class="form-control" id="apellido_paterno" name="apellido_paterno"
                                placeholder="Apellido Paterno" required>
                        </div>
                        <div class="col">
                            <input type="text" class="form-control" id="apellido_materno" name="apellido_materno"
                                placeholder="Apellido Materno" required>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="fecha_nacimiento">Fecha de Nacimiento</label>
                    <input type="date" class="form-control" id="fecha_nacimiento" name="fecha_nacimiento" required>
                </div>
                <div class="form-group">
                    <label for="genero">Género</label>
                    <select class="form-control" id="genero" name="genero">
                        <option>Masculino</option>
                        <option>Femenino</option>
                        <option>Otro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="telefono">Teléfono</label>
                    <input type="tel" class="form-control" id="telefono" name="telefono">
                </div>
                <div class="form-group">
                    <label for="email">Correo Electrónico</label>
                    <input type="email" class="form-control" id="email" name="email" placeholder="ejemplo@dominio.com"
                        required>
                </div>
                    <div class="form-group">
                        <label for="peso">Peso</label>
                        <input type="number" min="10" max="600" id="peso" name="peso" placeholder="00"></input>
                        <label>kg</label> 
                    </div>
                    <div class="form-group">
                        <label for="estatura">Estatura</label>
                        <input type="number" min="0.50" max="2.99" step="0.01" id="estatura" name="estatura" placeholder="1.00"></input>
                        <label>m</label> 
                    </div>
                    <h4>Motivo de la consulta</h4>
                    <div class="form-group">
                        <label for="sintomas">Síntomas actuales</label>
                        <select class="form-control" id="sintomas" name="sintomas">
                            <option value="Dolor en el pecho">Dolor en el pecho</option>
                            <option value="Palpitaciones">Palpitaciones</option>
                            <option value="Fatiga">Fatiga</option>
                            <option value="Mareos y/o desmayos">Mareos y/o desmayos</option>
                            <option value="Hinchazón en piernas/tobillos">Hinchazón en piernas/tobillos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fecha_sintomas">¿Cuándo comenzaron los sintomas?</label>
                        <input type="date" class="form-control" id="fecha_sintomas" name="fecha_sintomas" required>
                    </div>
                    <h4>Antecedentes médicos</h4>
                    <div class="form-group">
                        <label for="enfermedades">¿Tiene alguna enfermedad diagnosticada?</label>
                        <select class="form-control" id="enfermedades" name="enfermedades">
                            <option value="Hipertension">Hipertension</option>
                            <option value="Colesterol alto">Colesterol alto</option>
                            <option value="Trigliceridos alto">Trigliceridos alto</option>
                            <option value="Ninguna">Ninguna</option>
                        </select>
                    </div>
                    <h4>Antecedentes familiares</h4>
                    <div class="form-group">
                        <label for="antecedentes_familiares">¿Tiene familiares que hayan tenido un infarto?</label>
                        <select class="form-control" id="antecedentes_familiares" name="antecedentes_familiares">
                            <option value="Sí">Sí</option>
                            <option value="No">No</option>
                        </select>
                        <button type="submit" class="btn btn-outline-info">Registrar</button>
                    </div>
                    

     <!-- Modal para confirmación de éxito -->
     <div class="modal fade" id="successModal" tabindex="-1" role="dialog" aria-labelledby="successModalLabel"
     aria-hidden="true">
     <div class="modal-dialog" role="document">
         <div class="modal-content">
             <div class="modal-header">
                 <h5 class="modal-title" id="successModalLabel">Registro Exitoso</h5>
                 <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                     <span aria-hidden="true">&times;</span>
                 </button>
             </div>
             <div class="modal-body">
                 Paciente Registrado con éxito.
             </div>
             <div class="modal-footer">
                 <button type="button" class="btn btn-success" data-dismiss="modal">Aceptar</button>
             </div>
         </div>
     </div>
 </div>

 <!-- Modal para Errores -->
 <div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel"
     aria-hidden="true">
     <div class="modal-dialog" role="document">
         <div class="modal-content">
             <div class="modal-header">
                 <h5 class="modal-title" id="errorModalLabel">Error</h5>
                 <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                     <span aria-hidden="true">&times;</span>
                 </button>
             </div>
             <div class="modal-body">
                 Error al registrar el paciente. Por favor, intente nuevamente.
             </div>
             <div class="modal-footer">
                 <button type="button" class="btn btn-danger" data-dismiss="modal">Cerrar</button>
             </div>
         </div>
     </div>
 </div>



<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
<script>
    $(document).ready(function () {
        const input = document.querySelector("#telefono");
        const iti = window.intlTelInput(input, {
            preferredCountries: ["mx", "us"],
            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
        });

        $('#registro-paciente-form').submit(function (e) {
            e.preventDefault();  // Previene la recarga de la página por el envío del formulario.

            // Concatenar nombres
            var nombreCompleto = $('#nombres').val() + ' ' + $('#apellido_paterno').val() + ' ' + $('#apellido_materno').val();

            // Obtener el número de teléfono en formato internacional
            var telefono = iti.getNumber();

            // Ajustar la fecha de nacimiento para evitar problemas de zona horaria
            var fechaNacimiento = new Date($('#fecha_nacimiento').val());
            fechaNacimiento.setMinutes(fechaNacimiento.getMinutes() + fechaNacimiento.getTimezoneOffset())
            
            
            var datosPaciente = {
           nombre: nombreCompleto.trim(),
           fecha_nacimiento: fechaNacimiento.toISOString().slice(0,10), // Formato YYYY-MM-DD
           genero: $('#genero').val(),
           telefono: telefono,
           email: $('#email').val(),
           fecha_registro: new Date().toISOString().slice(0, 19).replace('T', ' '),
           peso: $('#peso').val() ? parseFloat($('#peso').val()) : null,  // Convertir a número o null
           estatura: $('#estatura').val() ? parseFloat($('#estatura').val()) : null,  // Convertir a número o null
           sintomas: $('#sintomas').val(),
           fecha_sintomas: $('#fecha_sintomas').val(),
           enfermedades: $('#enfermedades').val(),
           antecedentes_familiares: $('#antecedentes_familiares').val()
};
var formData = new FormData(); // Recoger todos los campos del formulario
            formData.append('datosPaciente', JSON.stringify(datosPaciente)); // Convertir objeto a JSON

            $.ajax({
                type: "POST",
                url: "/pacientes-inicio",
                data: datosPaciente,
                success: function (response) {
                    console.log("Respuesta del servidor:", response);
                    $('#successModal .modal-body').text(response.message); // Actualiza el cuerpo del modal con el mensaje del servidor.
                    $('#successModal').modal('show');
                    
                    // Redirige al perfil de usuario
                     setTimeout(function () {
                     window.location.href = "/mi-perfil/" + response.pacienteId;  // Redirige al perfil con el ID del paciente
                     }, 2000);  // Espera 2 segundos antes de redirigir para que el usuario vea el mensaje de éxito.
                    // Limpiar el formulario si el registro fue exitoso
                    $('#registro-paciente-form')[0].reset();
                    iti.setNumber(''); // Limpiar el campo de teléfono
                    
                },
                error: function (xhr) {
                    console.log("Error del servidor:", xhr.responseJSON);
                    $('#errorModal .modal-body').text(xhr.responseJSON.error);
                    $('#errorModal').modal('show');
                }
            });
        });
    });
</script>
</body>
</html>