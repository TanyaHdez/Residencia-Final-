<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inicio</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="icon" href="/assets/logo.png" sizes="200x200 100x100" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css" />

    <style>
        body {
            display: flex;
        }

        .sidebar {
            width: 250px;
            height: 100vh;
            background: #343a40;
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            padding-top: 20px;
            text-align: center;
        }

        .sidebar img {
            width: 50px;
            margin-bottom: 10px;
        }

        .sidebar h4 {
            margin-bottom: 20px;
            font-size: 20px;
        }

        .sidebar a {
            padding: 15px 10px;
            text-decoration: none;
            font-size: 18px;
            color: white;
            display: block;
        }

        .sidebar a:hover {
            background: #495057;
        }

        .sidebar .logout-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            cursor: pointer;
            width: 100%;
            padding: 10px;
            margin-top: 20px;
        }

        .content {
            margin-left: 250px;
            padding: 20px;
            width: 100%;
        }

        .top-bar {
            display: flex;
            justify-content: flex-end;
            padding: 10px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }

        .form-container {
            max-width: 600px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

         /* Botón cerrar sesión arriba */
         .top-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 10px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }

        .top-bar button {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 16px;
            cursor: pointer;
        }

        .top-bar button:hover {
            color: #c82333;
        }

        .table-container {
            border: 1px solid #ddd;
            border-radius: 0.45rem;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            background-color: white;
        }
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: #90c0c6;
        }
        .table-header .table-title {
            font-family: Arial, sans-serif;
            font-size: 24px;
            font-weight: bold;
        }
        .table-header .search-container {
            display: flex;
            align-items: center;
        }
        .table-header .search-container input {
            border-radius: 0.25rem;
            border: 1px solid #ddd;
            padding: 0.5rem;
            margin-right: 0.5rem;
        }
        .table-custom {
            width: 100%;
        }
        .table-custom th, .table-custom td {
            text-align: center;
            vertical-align: middle;
            padding: 0.75rem;
        }
        .table-custom th {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        .table-custom .table-footer {
            background-color: #f8f9fa;
            text-align: right;
            padding: 0.75rem;
        }


        .sidebar a.logo img {
    cursor: pointer;
    transition: none !important; /* Evita efectos de transición */
}

.sidebar a.logo:focus img, a.logo:active img {
    outline: none !important;
    box-shadow: none !important;
    filter: none !important;
}

.sidebar a.logo:hover,
.sidebar a.logo:hover img,
.sidebar a.logo:hover h4 {
    filter: none !important;
    color: inherit !important;
    background: transparent !important;
    box-shadow: none !important;
    text-decoration: none !important;
    opacity: 1 !important;
    transition: none !important;
}

/* Menú desplegable personalizado dentro de la sidebar */
.dropdown-container {
    position: relative;
    text-align: left;
    margin-bottom: 10px;
}

.main-title {
    background-color: #343a40;
    color: white;
    padding: 12px 16px;
    font-size: 18px;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

.main-title:hover {
    background-color: #495057;
}

.dropdown-menu {
    display: none;
    position: absolute;
    left: 100%; /* Aparece al lado derecho de la sidebar */
    top: 0;
    background-color: #f8f9fa;
    border-radius: 6px;
    box-shadow: 0 0 8px rgba(0,0,0,0.15);
    min-width: 200px;
    z-index: 1000;
    flex-direction: column;
}

.dropdown-menu a {
    display: block;
    padding: 10px 16px;
    color: #343a40;
    text-decoration: none;
    font-size: 16px;
}

.dropdown-menu a:hover {
    background-color: #343a40;
    color: #f8f9fa;
}

/* Mostrar el menú cuando el mouse pasa por el contenedor */
.main-title:hover + .dropdown-menu {
    display: block;
}


    </style>
</head>
<body>
    <div class="sidebar">
        <a href="/Admin.html" class="logo"><img src="/assets/logo.png" alt="CardioCloud Logo"><h4></h4></a>       
        <div class="dropdown-container">
        <div class="main-title">Bancos de pacientes</div>
        <div class="dropdown-menu">
        <a href="Perfiles-pacientes.html">Tabla de usuarios (px)</a>
        <a href="Datosdepacientes.html">Tabla de pacientes</a>
        </div>
        <a href="/Registrodepaciente">Registro de pacientes</a>
</div>
 
        <button class="logout-btn" onclick="window.location.href='/logout'">
            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
        </button>
    </div>

    <div class="content">
        <div class="top-bar">
            <button onclick="window.location.href='/logout'">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
            </button>
        </div>
        <script>
document.addEventListener('DOMContentLoaded', () => {
    const title = document.querySelector('.main-title');
    const menu = document.querySelector('.dropdown-menu');

    let overMenu = false;

    title.addEventListener('mouseenter', () => {
        menu.style.display = 'block';
    });

    title.addEventListener('mouseleave', () => {
        setTimeout(() => {
            if (!overMenu) menu.style.display = 'none';
        }, 200);
    });

    menu.addEventListener('mouseenter', () => {
        overMenu = true;
    });

    menu.addEventListener('mouseleave', () => {
        overMenu = false;
        menu.style.display = 'none';
    });
});
</script>
<div class="container mt-4">

  <!-- Contador de Total de Pacientes -->
  <div class="row">
    <div class="col-12 col-md-4">
      <div class="card shadow-sm border-left-primary p-3">
        <div class="text-white bg-primary font-weight-bold p-3">
          <h5>Total de Pacientes</h5>
          <h2 id="totalPacientes">7</h2>
        </div>
      </div>
    </div>
  </div>



  <!-- Tabla Pacientes por Doctor debajo del contador -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white">
          <h5 class="mb-0">Pacientes Registrados por Doctor</h5>
        </div>
        <div class="card-body table-responsive">
          <table class="table table-striped table-bordered text-center">
            <thead class="thead-dark">
              <tr>
                <th>Nombre del Doctor</th>
                <th>Total de Pacientes</th>
                <th>Pacientes Asignados</th>
                <th>Eliminar Doctor</th> 
              </tr>
            </thead>
            <tbody id="tablaPacientesPorDoctor">
              <!-- Se llenará con JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

</div>
<!-- Confirmation Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmación de Eliminación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        ¿Estás seguro de que quieres eliminar a este doctor y todos sus datos relacionados?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteButton">Confirmar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal for Success/Error messages -->
<div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="messageModalLabel">Mensaje</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modalMessageContent">
        <!-- The message will be dynamically inserted here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Bootstrap JS (with Popper.js for modals and tooltips) -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
<script>

document.addEventListener('DOMContentLoaded', () => {
  

    // Obtener total de pacientes
    fetch('/api/total-pacientes')
        .then(response => response.json())
        .then(data => {
            document.getElementById('totalPacientes').textContent = data.total;
        })
        .catch(error => {
            console.error('Error al obtener el total de pacientes:', error);
        });
});

// Obtener datos de pacientes por doctor y mostrarlos en tabla
fetch('/api/pacientes-por-doctor')
    .then(response => response.json())
    .then(data => {
        const tablaBody = document.getElementById('tablaPacientesPorDoctor');
        tablaBody.innerHTML = ''; // Limpiar cualquier dato previo

        data.forEach(doctor => {
            const row = document.createElement('tr');
           row.innerHTML = `
  <td>${doctor.nombre_doctor}</td>
  <td>${doctor.total_pacientes}</td>
  <td>${doctor.nombres_pacientes || 'Sin pacientes registrados'}</td>
  <td>
    <button class="btn btn-danger btn-sm" onclick="confirmDelete(${doctor.doctor_id})">
      Eliminar
    </button>
  </td>
`;
            tablaBody.appendChild(row);
        });
    })
    .catch(error => {
        console.error('Error al obtener pacientes por doctor:', error);
    });

    let doctorIdtoDelete = null;

    function confirmDelete(idDoctor) {
    doctorIdToDelete = idDoctor; // Store the doctor ID to be deleted
    const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
    modal.show(); // Show the modal
  }

  // Function to actually delete the doctor
  function deleteDoctor() {
    if (doctorIdToDelete !== null) {
      fetch(`/api/doctores/${doctorIdToDelete}`, {
        method: 'DELETE'
      })
      .then(res => {
        if (!res.ok) throw new Error("Error al eliminar doctor");
        return res.json();
      })
      .then(data => {
        showMessageModal(data.message|| 'El doctor ha sido eliminado con éxito.', 'success');
        setTimeout(()=>{
        location.reload(); // Reload the page to reflect the changes
      },1500);
    })
      .catch(err => {
        console.error(err);
        showMessageModal('Error al eliminar el doctor','error');
      });
    }
  }

 // Function to display the message modal (Success/Error)
function showMessageModal(message, type) {
  const modalMessageContent = document.getElementById('modalMessageContent');
  modalMessageContent.textContent = message;

  // Optionally, change the modal's title or style based on success or error
  const modalTitle = document.getElementById('messageModalLabel');
  if (type === 'success') {
    modalTitle.textContent = 'Éxito';
  } else {
    modalTitle.textContent = 'Error';
  }

  // Show the modal
  const modal = new bootstrap.Modal(document.getElementById('messageModal'));
  modal.show();
}

// Listen for the Confirm Delete button click
document.getElementById('confirmDeleteButton').addEventListener('click', function() {
  deleteDoctor(); // Delete the doctor if the user confirms
  const modal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal'));
  modal.hide(); // Hide the confirmation modal after the action is confirmed
});
</script>


</body>

</html>
