<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi-perfil</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="icon" href="/assets/logo.png" sizes="16x16 32x32" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css" />
  <style>
        body {
            display: flex;
        }

        .sidebar {
            width: 250px;
            height: 100vh;
            background: #343a40;
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            padding-top: 20px;
            text-align: center;
        }

        .sidebar img {
            width: 50px;
            margin-bottom: 10px;
        }

        .sidebar h4 {
            margin-bottom: 20px;
            font-size: 20px;
        }

        .sidebar a {
            padding: 15px 10px;
            text-decoration: none;
            font-size: 18px;
            color: white;
            display: block;
        }

        .sidebar a:hover {
            background: #495057;
        }

        .sidebar .logout-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            cursor: pointer;
            width: 100%;
            padding: 10px;
            margin-top: 20px;
        }

        .content {
            margin-left: 250px;
            padding: 20px;
            width: 100%;
        }

        .content .top-bar {
            display: flex;
            justify-content: flex-end;
            padding: 10px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }

        .form-container {
            max-width: 600px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

         /* Botón cerrar sesión arriba */
         .content .top-bar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 10px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }

        .content .top-bar button {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 16px;
            cursor: pointer;
        }

        .content .top-bar button:hover {
            color: #c82333;
        }

        #nombre { 
        width: fit-content;
        min-width: 200px;
        max-width: 100%;
        border: none;
        outline: none;
        background: transparent;
        font-family: inherit;
        font-size: inherit;
        }

        .sidebar a.logo img {
    cursor: pointer;
    transition: none !important; /* Evita efectos de transición */
}

.sidebar a.logo:focus img, a.logo:active img {
    outline: none !important;
    box-shadow: none !important;
    filter: none !important;
}

.sidebar a.logo:hover,
.sidebar a.logo:hover img,
.sidebar a.logo:hover h4 {
    filter: none !important;
    color: inherit !important;
    background: transparent !important;
    box-shadow: none !important;
    text-decoration: none !important;
    opacity: 1 !important;
    transition: none !important;
}

    </style>
</head>
<body>
    <div class="sidebar">
       <a href="" class="logo">  <img src="/assets/logo.png" alt="CardioCloud Logo">
        <h4></h4></a>
        <button class="logout-btn" onclick="window.location.href='/logout'">
            <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
        </button>
    </div>

    <div class="content">
        <div class="top-bar">
            <button onclick="window.location.href='/logout'">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
            </button>
        </div>


</head>
<body>
  <h1>Mi perfil</h1>
  <div>
    <p><strong>Nombre:</strong> <input id="nombre" readonly></p>
    <p><strong>Genero:</strong>
    <select id="genero" class="form-control" disabled>
        <option value="Masculino">Masculino</option>
        <option value="Femenino">Femenino</option>
        <option value="Otro">Otro</option>
    </select></p>
    <p><strong>Fecha de nacimiento:</strong> <input type="date" id="fecha_nacimiento" class="form-control" readonly></p>
    <p><strong>Teléfono:</strong> <input type="text" id="telefono" class="form-control" readonly></p>
    <p><strong>Email:</strong> <input type="email" id="email" name="email" class="form-control" readonly></p>
    <p><strong>Peso(kilogramos):</strong>  <input type="number" id="peso" min="0" max="500" class="form-control" readonly></p>
    <p><strong>Estatura (metros): </strong><input type="number" step="0.01" id="estatura" min="0" max="2.30" class="form-control" readonly></p>
    <p><strong>Síntomas:</strong> 
        <select id="sintomas" class="form-control" disabled>
            <option value="Dolor en el pecho">Dolor en el pecho</option>
            <option value="Palpitaciones">Palpitaciones</option>
            <option value="Fatiga">Fatiga</option>
            <option value="Mareos y/o desmayos">Mareos y/o desmayos</option>
            <option value="Hinchazón en piernas/tobillos">Hinchazón en piernas/tobillos</option>
        </select></p>
    <p><strong>Fecha en que comenzaron los síntomas:</strong> <input type="date" id="fecha_sintomas" class="form-control" readonly></p>
    <p><strong>Enfermedades diagnosticadas:</strong> 
    <select id="enfermedades" class="form-control" disabled>
        <option value="Hipertension">Hipertension</option>
        <option value="Colesterol alto">Colesterol alto</option>
        <option value="Trigliceridos alto">Trigliceridos alto</option>
        <option value="Ninguna">Ninguna</option>
    </select></p>
    <p><strong>Antecedente familiar de infarto:</strong> 
        <select id="antecedentes_familiares" class="form-control" disabled>
            <option value="Sí">Sí</option>
            <option value="No">No</option>
        </select>
    </p>
</div>

<!-- Botones -->
<button class="btn btn-outline-warning mt-3" id="editProfile">Modificar Datos</button>
<button class="btn btn-outline-success mt-3" id="saveProfile" style="display:none;">Guardar Cambios</button>
<button class="btn btn-outline-primary mt-3" id="UploadModal">Subir Archivo</button>
<!-- Botón para ver archivos -->
<button id="viewFilesButton" class="btn btn-outline-dark mt-3" style="display: inline-block;" onclick="viewFiles()">Ver mis archivos</button>


    
    <!-- Modal para subir archivos -->
    <div class="modal fade" id="uploadModal" tabindex="-1" role="dialog" aria-labelledby="uploadModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">Subir Archivos para <span id="patientName"></span></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="uploadForm">
                        <div class="form-group">
                            <label for="fileType">Tipo de Archivo</label>
                            <select class="form-control" id="fileType">
                                <option value="electrocardiograma">Electrocardiograma</option>
                                <option value="fonocardiograma">Fonocardiograma</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fileInput">Seleccionar archivo</label>
                            <input type="file" class="form-control-file" id="fileInput">
                        </div>
                        <input type="hidden" id="patientId" value="">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" data-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-outline-info" onclick="submitFile()">Subir Archivo</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de éxito para subida de archivos -->
    <div class="modal fade" id="uploadSuccessModal" tabindex="-1" role="dialog" aria-labelledby="uploadSuccessModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadSuccessModalLabel">Subida Exitosa</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Archivo subido con éxito.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-success" data-dismiss="modal">Aceptar</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal para actualizar perfil -->
<div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Perfil actualizado</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
        </div>
        <div class="modal-body">
          ¡El perfil se ha actualizado correctamente!
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline-success" data-dismiss="modal">Aceptar</button>
        </div>
      </div>
    </div>
  </div>

   <!-- Modal error al actualizar perfil -->
<div class="modal fade" id="failModal" tabindex="-1" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Error al actualizar</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
        </div>
        <div class="modal-body">
          Ha ocurrido un error al actualizar el perfil, intentalo de nuevo.
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-outline-success" data-dismiss="modal">Aceptar</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal de error -->
<div id="errorModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">Error</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="errorModalMessage"></p> <!-- Aquí se muestra el mensaje de error -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
               </div>
           </div>
       </div>
 </div>

    
    
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    
  <script>
    document.addEventListener('DOMContentLoaded', function() {
    // Obtener el ID del paciente de la URL
    const pacienteId = window.location.pathname.split('/').pop();

});

    document.addEventListener('DOMContentLoaded', function() {
      // Obtener el ID del paciente de la URL
      const pacienteId = window.location.pathname.split('/').pop();

      // Hacer una solicitud para obtener los datos del paciente
      fetch(`/api/mi-perfil/${pacienteId}`)
     .then(response => {
    if (!response.ok) {
      throw new Error(`Error HTTP: ${response.status}`);
    }
    return response.json();
     })
     .then(data => {
    if (!data.paciente) {
      throw new Error("Paciente no encontrado");
    }
    function formatDate(fecha) {
    if (!fecha) return ""; // Maneja valores nulos o vacíos

    let partes = fecha.split("/"); // Suponiendo que viene en formato dd/mm/yyyy
    if (partes.length === 3) {
        return `${partes[2]}-${partes[1].padStart(2, '0')}-${partes[0].padStart(2, '0')}`; // Convierte a yyyy-mm-dd
    }
    return fecha; // Si el formato es inesperado, lo deja igual
}
    document.getElementById('nombre').value = data.paciente.nombre || "No disponible";
    document.getElementById('genero').value = data.paciente.genero || "No disponible";
    document.getElementById('fecha_nacimiento').value = formatDate(data.paciente.fecha_nacimiento);
    document.getElementById('telefono').value = data.paciente.telefono || "No disponible";
    document.getElementById('email').value = data.paciente.email || "No disponible";
    document.getElementById('peso').value = data.paciente.peso|| "No disponible";
    document.getElementById('estatura').value = data.paciente.estatura || "No disponible";
    document.getElementById('sintomas').value = data.paciente.sintomas || "No disponible";
    document.getElementById('fecha_sintomas').value = formatDate(data.paciente.fecha_sintomas);
    document.getElementById('enfermedades').value = data.paciente.enfermedades || "No disponible";
    document.getElementById('antecedentes_familiares').value = data.paciente.antecedentes_familiares || "No disponible";
  
  
    document.getElementById('patientName').textContent = data.paciente.nombre;
    document.getElementById('patientId').value = pacienteId;
  })
  .catch(error => {
    console.error('Error al cargar los datos del perfil:', error);
    alert('Error al cargar el perfil');
  });
// Evento para abrir el modal al hacer clic en el botón "Subir Archivo"
document.getElementById('UploadModal').addEventListener('click', function () {
        $('#uploadModal').modal('show');
    });
});

document.getElementById('editProfile').addEventListener('click', function() {
    // Habilitar edición en los campos
    let inputs = document.querySelectorAll(' #genero, #fecha_nacimiento, #telefono, #email, #peso, #estatura, #sintomas, #fecha_sintomas, #enfermedades');
    inputs.forEach(input => input.removeAttribute('readonly'));

    // Habilitar el select
    document.getElementById('genero').removeAttribute('disabled');
    document.getElementById('antecedentes_familiares').removeAttribute('disabled');
    document.getElementById('enfermedades').removeAttribute('disabled');
    document.getElementById('sintomas').removeAttribute('disabled');
    // Mostrar el botón "Guardar Cambios"
    document.getElementById('saveProfile').style.display = 'inline-block';
    this.style.display = 'none';
});

document.getElementById('saveProfile').addEventListener('click', function() {
    const pacienteId = window.location.pathname.split('/').pop();
    const email = document.getElementById('email').value;
    
    // Expresión regular para validar el formato del email
    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

    // Verificar si el email es válido
    if (!emailRegex.test(email)) {
        console.error("Por favor, ingresa un email válido.");
        return;  // Detener la ejecución si el email no es válido
    }

    const updatedData = {
        genero: document.getElementById('genero').value,
        fecha_nacimiento: document.getElementById('fecha_nacimiento').value,
        telefono: document.getElementById('telefono').value,
        email: document.getElementById('email').value,
        peso: document.getElementById('peso').value,
        estatura: document.getElementById('estatura').value,
        sintomas: document.getElementById('sintomas').value,
        fecha_sintomas: document.getElementById('fecha_sintomas').value,
        enfermedades: document.getElementById('enfermedades').value,
        antecedentes_familiares: document.getElementById('antecedentes_familiares').value
    };

    fetch(`/api/mi-perfil/${pacienteId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(updatedData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 🔹 Mostrar el modal de éxito
            let modal = new bootstrap.Modal(document.getElementById('successModal'));
            modal.show();

            // Deshabilitar edición
            let inputs = document.querySelectorAll(' #genero, #fecha_nacimiento, #telefono, #email, #peso, #estatura, #sintomas, #fecha_sintomas, #enfermedades');
            inputs.forEach(input => input.setAttribute('readonly', true));

            document.getElementById('sintomas').setAttribute('disabled', true);
            document.getElementById('genero').setAttribute('disabled', true);
            document.getElementById('enfermedades').setAttribute('disabled', true);
            document.getElementById('antecedentes_familiares').setAttribute('disabled', true);

            // Mostrar botón de "Modificar Datos" y ocultar "Guardar Cambios"
            document.getElementById('editProfile').style.display = 'inline-block';
            document.getElementById('saveProfile').style.display = 'none';
        } else {
           let modal = new bootstrap.Modal(document.getElementById('failModal'));
           modal.show(); 
        }
    })
    .catch(error => console.error('Error al actualizar perfil:', error));
});


    function submitFile() {
        var fileInput = $('#fileInput')[0].files[0];
    var fileType = $('#fileType').val();
    var patientId = $('#patientId').val();
           // Verificar que un archivo haya sido seleccionado
    if (!fileInput) {
        $('#errorModal').modal('show');
        $('#errorModalMessage').text('No se ha seleccionado un archivo.');
        return;
    }

    // Verificar la extensión del archivo
    var allowedExtensions = ['mp3', 'wav', 'dat', 'hea']; // No incluir el punto
    var fileExtension = fileInput.name.split('.').pop().toLowerCase(); // Obtener la extensión en minúsculas

    if (!allowedExtensions.includes(fileExtension)) {
        // Mostrar un modal de error si el archivo no es válido
        $('#errorModal').modal('show');
        $('#errorModalMessage').text('Archivo no válido. Solo se permiten archivos .mp3, .wav, .dat y .hea.');
        return;  // Detener la ejecución si el archivo no es válido
    }
        
           var formData = new FormData();
           
            formData.append('file', $('#fileInput')[0].files[0]);
            formData.append('type', $('#fileType').val());  // Incluir el tipo de archivo seleccionado
            formData.append('patientId', $('#patientId').val());  // ID del paciente para asociar el archivo

            console.log("Datos a enviar:");
            console.log("File:", $('#fileInput')[0].files[0]);
            console.log("Type:", $('#fileType').val());
            console.log("Patient ID:", $('#patientId').val());

                    $.ajax({
                        type: "POST",
                        url: "/archivo_px",
                        data: formData,
                        processData: false,
                        contentType: false,
                        success: function (response) {
                            if(response.success){
                                $('#uploadModal').modal('hide');
                                $('#uploadSuccessModal').modal('show');
                                setTimeout(() => {
                                    $('#uploadSuccessModal').modal('hide');
                                }, 3000);
                         
                        }else{
                                 $('#uploadModal').modal('hide');
                                alert('Error: ' + response.message);
                            }
                        },
                        error: function () {
                            $('#uploadModal').modal('hide');
                            alert('Error al subir archivo.');
                        }
                    });
                }

             // Mostrar el botón "Ver mis archivos" y guardar el ID del paciente
             document.getElementById('viewFilesButton').style.display = 'inline-block';  
       // Redirigir a la página de respuestas del médico según el ID del paciente
function viewFiles() {
    const patientId = document.getElementById('patientId').value;
    window.location.href = `/Respuestas-medicos/${patientId}`;
}
</script>         
</body>
</html>

